#!/bin/bash
# malware_checks.sh
# - Full malware detection & file integrity: AIDE, chkrootkit, rkhunter, ClamAV
# - Writes AIDE config and initializes DB (mirrors file in debian.sh)


source ./os_misc.sh
log "[malware_checks] Installing and running malware detection tools."

apt install -y aide chkrootkit rkhunter clamav clamav-daemon || true

# chkrootkit
if command -v chkrootkit &> /dev/null; then
    log "[malware_checks] Running chkrootkit..."
    chkrootkit || true
fi

# rkhunter defaults already specified in app_security; run/update anyway
if command -v rkhunter &> /dev/null; then
    log "[malware_checks] Updating and checking rkhunter..."
    rkhunter --update || true
    rkhunter --check || true
    rkhunter --propupd || true
    rkhunter -c --enable all --disable none || true
fi

# ClamAV
if command -v freshclam &> /dev/null; then
    log "[malware_checks] Updating ClamAV DB..."
    freshclam || true
    log "[malware_checks] Running clamscan (recursive). This may take a long time..."
    clamscan -r --bell -i / | tee ./clamscan_full.log || true
fi

# AIDE configuration & init (preserved from debian.sh)
cat > /etc/aide/aide.conf <<EOF
# AIDE configuration for CyberPatriot
database = /var/lib/aide/aide.db
database_out = /var/lib/aide/aide.db.new
gzip_dbout = yes
exclude = /tmp
exclude = /var/tmp
exclude = /var/log
exclude = /var/run
exclude = /var/cache
dir = /etc
dir = /bin
dir = /sbin
dir = /usr
dir = /lib
dir = /lib64
dir = /root
dir = /home
dir = /opt
dir = /var/spool
dir = /var/lib
dir = /var/opt
file = /etc/passwd
file = /etc/shadow
file = /etc/group
file = /etc/gshadow
file = /etc/hostname
file = /etc/hosts
file = /etc/sudoers
EOF

log "[malware_checks] Initializing AIDE DB (aideinit) - may create /var/lib/aide/aide.db.new"
aideinit || true
if [[ -f /var/lib/aide/aide.db.new ]]; then
    mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db 2>/dev/null || true
fi

log "[malware_checks] Running aide --check (may be slow)..."
aide --check || true

# Create an incident-response helper script as original did (non-destructive)
if [[ -x "$(command -v systemctl)" ]]; then
    cat > /usr/local/bin/incident-response.sh << 'EOF'
#!/bin/bash
# Incident response helper (created by malware_checks)
mkdir -p /var/log/incidents/$(date +%Y%m%d_%H%M%S)
cd /var/log/incidents/$(date +%Y%m%d_%H%M%S)
ps auxf > processes.txt
lsof > open_files.txt
netstat -antup > network_connections.txt
ss -tualpn > socket_statistics.txt
cp /var/log/syslog . 2>/dev/null || true
cp /var/log/auth.log . 2>/dev/null || true
uname -a > system_info.txt
df -h > disk_usage.txt
free -m > memory_usage.txt
dpkg -l > installed_packages.txt
EOF
    chmod +x /usr/local/bin/incident-response.sh || true
fi

log "[malware_checks] Completed malware checks."
